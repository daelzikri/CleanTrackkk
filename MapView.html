<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Peta Persebaran - CleanTrack</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#2A62C8",
                        "secondary": "#50E3C2",
                        "background-light": "#f8fafc",
                        "surface": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"]
                    }
                }
            }
        }
    </script>

    <script src="user-header.js"></script>
    <script src="user-utils.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Hide Scrollbar Global */
        ::-webkit-scrollbar {
            display: none;
        }

        html,
        body {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* Map fills remaining height */
        #map-container {
            height: calc(100vh - 64px);
            width: 100%;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }

        /* Custom Marker Styles */
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #fff;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: currentColor;
            transform: rotate(45deg);
        }

        .pin-pending {
            background: #EF4444;
        }

        /* Merah */
        .pin-pending::after {
            background: white;
        }

        .pin-progress {
            background: #3B82F6;
        }

        /* Biru */
        .pin-progress::after {
            background: white;
        }

        .pin-resolved {
            background: #10B981;
        }

        /* Hijau */
        .pin-resolved::after {
            background: white;
        }

        /* Pulse Animation for User Location */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
                opacity: 1;
            }

            80%,
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        .user-pulse {
            position: absolute;
            height: 50px;
            width: 50px;
            border-radius: 50%;
            background: rgba(42, 98, 200, 0.4);
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        /* Popup Styling Fix */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }

        .leaflet-popup-content {
            margin: 0;
            width: 280px !important;
        }
    </style>
</head>

<body class="bg-background-light font-display text-slate-800 antialiased overflow-hidden">

    <div id="app-header"></div>

    <div id="map-container">

        <div id="map"></div>

        <div class="absolute top-4 right-4 z-[400] flex flex-col gap-3">

            <div class="bg-white/90 backdrop-blur-md p-4 rounded-xl shadow-lg border border-slate-200 w-48">
                <h3 class="text-xs font-bold uppercase text-slate-500 mb-3 tracking-wider">Status Laporan</h3>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span
                            class="w-3 h-3 rounded-full bg-blue-600 border border-white shadow-sm ring-1 ring-blue-100"></span>
                        <span class="text-xs font-bold text-slate-700">Lokasi Saya</span>
                    </div>
                    <div class="h-px bg-slate-200 my-1"></div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="text-xs font-medium text-slate-600">Pending (Belum)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                        <span class="text-xs font-medium text-slate-600">Diproses Petugas</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                        <span class="text-xs font-medium text-slate-600">Selesai Dibersihkan</span>
                    </div>
                </div>
            </div>

            <button id="btn-locate"
                class="bg-white p-3 rounded-xl shadow-lg border border-slate-200 text-slate-700 hover:text-primary hover:bg-slate-50 transition-colors flex items-center justify-center"
                title="Lokasi Saya">
                <span class="material-symbols-outlined">my_location</span>
            </button>
        </div>

        <div
            class="absolute bottom-8 left-4 right-4 z-[400] md:left-auto md:right-auto md:top-4 md:left-4 md:bottom-auto pointer-events-none">
            <div
                class="bg-white/95 backdrop-blur-md p-4 rounded-2xl shadow-xl border border-slate-200 w-full md:w-80 pointer-events-auto">
                <div class="flex items-center gap-3">
                    <div class="bg-primary/10 p-2.5 rounded-xl text-primary">
                        <span class="material-symbols-outlined text-2xl">public</span>
                    </div>
                    <div>
                        <h2 class="font-bold text-slate-900 text-sm">Peta Transparansi</h2>
                        <p class="text-xs text-slate-500">Pantau seluruh aktivitas kebersihan kota secara real-time.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let map;
        let userMarker;
        const DEFAULT_CENTER = [-8.5833, 116.1167]; // Mataram

        document.addEventListener('DOMContentLoaded', () => {
            renderHeader('map');
            initMap();
        });

        function initMap() {
            // 1. Init Leaflet
            map = L.map('map', { zoomControl: false }).setView(DEFAULT_CENTER, 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // 2. Render ALL Reports (Public View)
            renderReportMarkers();

            // 3. Try Locate User immediately
            locateUser();

            // Event Listener
            document.getElementById('btn-locate').addEventListener('click', locateUser);
        }

        function locateUser() {
            const btn = document.getElementById('btn-locate');
            btn.classList.add('animate-pulse', 'text-primary');

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Add/Update User Marker
                        if (userMarker) map.removeLayer(userMarker);

                        const userIcon = L.divIcon({
                            className: 'custom-user-icon',
                            html: `<div class="relative flex items-center justify-center">
                                    <div class="user-pulse"></div>
                                    <div class="w-4 h-4 bg-primary border-2 border-white rounded-full shadow-lg relative z-10"></div>
                                   </div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });

                        userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map)
                            .bindPopup("<b>Lokasi Anda</b><br>GPS Aktif").openPopup();

                        map.flyTo([lat, lng], 15);
                        btn.classList.remove('animate-pulse');
                    },
                    (error) => {
                        console.error("GPS Error:", error);
                        btn.classList.remove('animate-pulse', 'text-primary');
                        // Fallback to default center if GPS fails
                        map.setView(DEFAULT_CENTER, 13);
                    }
                );
            }
        }

        function renderReportMarkers() {
            // LOAD ALL DATA (TRANSPARANSI TOTAL)
            // Tidak ada filter userId di sini, semua laporan ditampilkan.
            const reports = getSharedReports(); // Function from user-utils.js

            reports.forEach(report => {
                // Generate Simulated Coords from Location String
                const coords = generateCoordinates(report.location);
                const style = getPinStyle(report.status);

                // UPDATE: Ikon Universal (Location On)
                const customIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div class="marker-pin ${style.cssClass}">
                            <span class="material-symbols-outlined text-[18px] text-white" style="transform: rotate(45deg)">
                                ${style.icon}
                            </span>
                           </div>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42],
                    popupAnchor: [0, -35]
                });

                // SMART POPUP CONTENT
                // Fitur Kunci: Menampilkan Admin Notes agar warga tahu update petugas
                let adminNoteHtml = '';
                if (report.adminNotes) {
                    adminNoteHtml = `
                        <div class="mt-3 p-2.5 bg-blue-50 border border-blue-100 rounded-lg">
                            <p class="text-[10px] font-bold text-blue-600 uppercase mb-1 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[12px]">admin_panel_settings</span> Info Petugas
                            </p>
                            <p class="text-xs text-blue-900 leading-snug">"${report.adminNotes}"</p>
                        </div>
                    `;
                }

                // UPDATE: Hapus Category dari Popup
                const popupContent = `
                    <div class="font-display bg-white overflow-hidden flex flex-col">
                        <div class="relative h-24 bg-slate-100">
                             ${report.photos && report.photos.length > 0 ?
                        `<img src="${report.photos[0]}" class="w-full h-full object-cover">` :
                        `<div class="flex items-center justify-center h-full text-slate-300"><span class="material-symbols-outlined">image_not_supported</span></div>`
                    }
                             <div class="absolute top-2 left-2">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${style.badgeClass} shadow-sm border border-white/20">
                                    ${report.status}
                                </span>
                             </div>
                        </div>
                        
                        <div class="p-3">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] text-slate-400 font-mono">#${report.id}</span>
                            </div>
                            
                            <p class="text-xs text-slate-500 mb-2 line-clamp-2 font-bold">${report.description.substring(0, 50)}...</p>
                            
                            <div class="flex items-center gap-1 text-xs text-slate-400">
                                <span class="material-symbols-outlined text-[14px]">location_on</span>
                                <span class="truncate max-w-[180px]">${report.location}</span>
                            </div>

                            ${adminNoteHtml}
                            
                            <div class="mt-3 pt-2 border-t border-slate-100 flex justify-between items-center">
                                <span class="text-[10px] text-slate-400">Pelapor: ${report.reporterName.split(' ')[0]}...</span>
                                <span class="text-[10px] text-slate-400">${report.date}</span>
                            </div>
                        </div>
                    </div>
                `;

                L.marker(coords, { icon: customIcon })
                    .addTo(map)
                    .bindPopup(popupContent);
            });
        }

        // Helper: Generate consistent coordinates from string
        function generateCoordinates(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            // Spread randomly around center (approx 3-5km radius)
            const offsetLat = (hash % 1000) / 30000;
            const offsetLng = ((hash * 2) % 1000) / 30000;

            return [DEFAULT_CENTER[0] + offsetLat, DEFAULT_CENTER[1] + offsetLng];
        }

        // UPDATE: Gunakan Ikon Universal (location_on) tapi warna tetap beda
        function getPinStyle(status) {
            if (status === 'Pending') return { cssClass: 'pin-pending', icon: 'location_on', badgeClass: 'bg-red-500 text-white' };
            if (status === 'In Progress') return { cssClass: 'pin-progress', icon: 'location_on', badgeClass: 'bg-blue-500 text-white' };
            return { cssClass: 'pin-resolved', icon: 'location_on', badgeClass: 'bg-green-500 text-white' };
        }

    </script>
</body>

</html>