<!DOCTYPE html>
<html lang="id" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lapor Sampah - CleanTrack</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#2A62C8",
                        "secondary": "#50E3C2",
                        "background-light": "#f8fafc",
                        "surface": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"],
                        "mono": ["Space Grotesk", "monospace"]
                    }
                }
            }
        }
    </script>

    <script src="user-utils.js"></script>
    <script src="user-header.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* SCANNED ANIMATION */
        @keyframes laser-scan {

            0%,
            100% {
                top: 0%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            50% {
                top: 100%;
                opacity: 1;
                box-shadow: 0 0 20px #50E3C2;
            }

            90% {
                opacity: 1;
            }
        }

        .scanner-beam {
            position: absolute;
            left: 0;
            width: 100%;
            height: 4px;
            background: #50E3C2;
            box-shadow: 0 0 15px #50E3C2, 0 0 30px #50E3C2;
            animation: laser-scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            z-index: 20;
        }

        /* GLASS INPUT FIELDS */
        .input-glass {
            background: transparent;
            border: none;
            border-bottom: 2px solid #e2e8f0;
            padding: 1rem 0;
            transition: all 0.3s ease;
            border-radius: 0;
        }

        .input-glass:focus {
            border-bottom-color: #2A62C8;
            box-shadow: none;
            background: linear-gradient(to bottom, transparent, rgba(42, 98, 200, 0.02));
        }

        /* CORNER BRACKETS FOR TECH FEEL */
        .tech-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #2A62C8;
            transition: all 0.3s ease;
        }

        .tc-tl {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
            border-radius: 8px 0 0 0;
        }

        .tc-tr {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
            border-radius: 0 8px 0 0;
        }

        .tc-bl {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
            border-radius: 0 0 0 8px;
        }

        .tc-br {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
            border-radius: 0 0 8px 0;
        }

        .group:hover .tech-corner {
            width: 30px;
            height: 30px;
            border-color: #50E3C2;
        }
    </style>
</head>

<body class="bg-background-light font-display text-slate-800 antialiased selection:bg-primary/20">

    <div id="app-header"></div>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-[calc(100vh-64px)]">

        <div class="max-w-5xl mx-auto" data-aos="fade-up" data-aos-duration="800">

            <!-- PAGE TITLE -->
            <div class="mb-8 flex items-center gap-3">
                <div class="p-3 bg-slate-900 text-white rounded-xl shadow-lg shadow-slate-300/50">
                    <span class="material-symbols-outlined text-2xl">document_scanner</span>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight text-slate-900">Laporan Baru</h1>
                    <p class="text-sm text-slate-500 font-medium">Sistem Pelaporan Cerdas Berbasis AI</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">

                <!-- LEFT COLUMN: SCANNER UI (5 cols) -->
                <div class="lg:col-span-5 space-y-6">

                    <!-- SCANNER CONTAINER -->
                    <div class="relative group">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">1. Bukti
                            Visual</label>

                        <div id="photo-upload-area"
                            class="relative w-full aspect-[4/5] bg-slate-100 rounded-3xl overflow-hidden cursor-pointer shadow-inner border border-slate-200 hover:shadow-xl transition-all duration-500 group-hover:scale-[1.01]">
                            <input type="file" id="file-input" class="hidden" accept="image/*">

                            <!-- Tech Corners Overlay -->
                            <div class="absolute inset-4 pointer-events-none z-30">
                                <div class="tech-corner tc-tl"></div>
                                <div class="tech-corner tc-tr"></div>
                                <div class="tech-corner tc-bl"></div>
                                <div class="tech-corner tc-br"></div>
                            </div>

                            <!-- STATE: IDLE -->
                            <div id="state-idle"
                                class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 z-20">
                                <div
                                    class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-lg mb-4 group-hover:scale-110 transition-transform duration-300">
                                    <span class="material-symbols-outlined text-4xl text-primary">add_a_photo</span>
                                </div>
                                <p class="text-base font-bold text-slate-700">Ambil Foto Sampah</p>
                                <p class="text-xs text-slate-400 mt-1 max-w-[200px]">Ketuk area ini untuk membuka kamera
                                    atau galeri.</p>
                            </div>

                            <!-- STATE: SCANNING -->
                            <div id="state-scanning" class="hidden absolute inset-0 bg-slate-900 z-40">
                                <img id="preview-img" class="w-full h-full object-cover opacity-50" src=""
                                    alt="Scanning">
                                <div class="scanner-beam"></div>
                                <div
                                    class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMDUiLz4KPC9zdmc+')] opacity-30">
                                </div>

                                <div class="absolute bottom-10 left-0 right-0 flex justify-center">
                                    <div
                                        class="bg-black/60 backdrop-blur-md px-6 py-2 rounded-full border border-white/10 flex items-center gap-3">
                                        <span
                                            class="material-symbols-outlined text-secondary animate-spin text-lg">data_usage</span>
                                        <span
                                            class="text-xs font-mono text-secondary font-bold tracking-widest">ANALYZING
                                            OBJECT...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- STATE: SUCCESS -->
                            <div id="state-success" class="hidden absolute inset-0 z-20">
                                <img id="final-img" class="w-full h-full object-cover" src="" alt="Final">
                                <div
                                    class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-transparent to-transparent">
                                </div>
                                <div class="absolute bottom-6 left-6 right-6">
                                    <div class="flex items-center gap-2 text-green-400 mb-1">
                                        <span class="material-symbols-outlined text-xl">check_circle</span>
                                        <span class="text-xs font-bold uppercase tracking-wider">AI Verified</span>
                                    </div>
                                    <p class="text-white text-sm opacity-80">Ketuk ulang untuk mengganti foto.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI RESULT BADGE -->
                    <div id="ai-success-msg"
                        class="hidden transform translate-y-4 opacity-0 transition-all duration-500">
                        <div
                            class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-2xl border border-blue-100 flex items-start gap-3 shadow-sm">
                            <span class="material-symbols-outlined text-primary text-xl mt-0.5">psychology</span>
                            <div>
                                <p class="text-xs font-bold text-primary uppercase mb-1">Analisis Cerdas</p>
                                <p class="text-sm text-slate-700 leading-snug">Sistem mendeteksi tumpukan sampah.
                                    Deskripsi telah diisi otomatis.</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT COLUMN: MAP & FORM (7 cols) -->
                <div class="lg:col-span-7 flex flex-col h-full">

                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">2. Lokasi &
                        Detail</label>

                    <!-- MAP CONTAINER (FULL WIDTH IN COLUMN) -->
                    <div
                        class="relative w-full h-64 lg:h-80 bg-slate-100 rounded-[2rem] overflow-hidden shadow-inner border border-slate-200 group">
                        <div id="map" class="absolute inset-0 z-0"></div>

                        <!-- Floating Location Button -->
                        <div class="absolute bottom-4 right-4 z-[400]">
                            <button id="btn-get-location"
                                class="w-12 h-12 bg-white text-slate-700 rounded-xl shadow-lg border border-slate-100 flex items-center justify-center hover:bg-slate-50 hover:text-primary transition-colors active:scale-95">
                                <span class="material-symbols-outlined text-xl">my_location</span>
                            </button>
                        </div>

                        <!-- Map Overlay Loading -->
                        <div id="map-loading"
                            class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm z-[500] flex flex-col items-center justify-center">
                            <span class="material-symbols-outlined text-4xl text-primary animate-spin mb-2">sync</span>
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Mencari Koordinat
                                GPS...</span>
                        </div>
                    </div>

                    <!-- LOCATION TEXT -->
                    <div class="mt-4 mb-8 flex items-start gap-3 px-2 transition-all" id="address-box">
                        <span class="material-symbols-outlined text-slate-400 mt-1">pin_drop</span>
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase">Titik Koordinat</p>
                            <p class="text-base font-bold text-slate-800 leading-tight" id="detected-address">Belum
                                ditentukan</p>
                            <p class="text-xs text-slate-400 font-mono mt-1" id="detected-coords">Lat: -, Lng: -</p>
                        </div>
                    </div>

                    <!-- GLASS FORM -->
                    <div class="space-y-8 flex-1">
                        <div class="relative">
                            <textarea id="input-desc" rows="2"
                                class="input-glass w-full text-lg font-medium text-slate-800 placeholder:text-slate-300 focus:ring-0 resize-none"
                                placeholder="Tulis detail tambahan di sini..."></textarea>
                            <label
                                class="absolute -top-3 left-0 text-[10px] font-bold text-primary uppercase tracking-wider bg-background-light px-1">Deskripsi
                                Laporan</label>
                        </div>

                        <div class="pt-4">
                            <button id="btn-submit" disabled
                                class="w-full py-5 rounded-2xl bg-slate-200 text-slate-400 font-black text-sm uppercase tracking-widest shadow-none transition-all flex items-center justify-center gap-3 disabled:cursor-not-allowed group-enabled:hover:bg-primary group-enabled:hover:shadow-xl group-enabled:hover:shadow-primary/30">
                                <span class="material-symbols-outlined text-xl">lock</span>
                                <span>Lengkapi Data</span>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- SUCCESS MODAL (HOLOGRAPHIC) -->
    <div id="success-modal"
        class="fixed inset-0 z-[1000] hidden flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md transition-opacity">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 relative overflow-hidden transform scale-95 opacity-0 transition-all duration-300"
            id="modal-content">

            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary to-secondary"></div>

            <div class="text-center">
                <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6 relative">
                    <span class="material-symbols-outlined text-5xl text-green-500">send</span>
                    <div id="reward-animation"
                        class="absolute -top-4 -right-4 bg-yellow-400 text-white text-xs font-black px-3 py-1 rounded-full shadow-lg transform rotate-12 hidden animate-bounce">
                        +10 PTS
                    </div>
                </div>

                <h2 class="text-2xl font-black text-slate-900 mb-2">Laporan Terkirim!</h2>
                <p class="text-slate-500 text-sm leading-relaxed mb-8">Terima kasih telah berkontribusi menjaga
                    kebersihan kota.</p>

                <button onclick="window.location.href='MyWasteReports.html'"
                    class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-primary transition-all shadow-xl active:scale-95">
                    Lihat Status Laporan
                </button>
            </div>
        </div>
    </div>

    <script>
        AOS.init();

        // STATE
        let currentUser = null;
        let isPhotoReady = false;
        let isLocationReady = false;
        let isSubmitting = false;
        let uploadedImageBase64 = null;
        let map, marker;

        document.addEventListener('DOMContentLoaded', () => {
            currentUser = requireLogin();
            renderHeader('new');
            initMap();
            setupEventListeners();
        });

        function initMap() {
            const startCoords = [-8.5833, 116.1167];
            map = L.map('map', { zoomControl: false }).setView(startCoords, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap', maxZoom: 19 }).addTo(map);
            setTimeout(() => { map.invalidateSize(); }, 200);
        }

        function setupEventListeners() {
            const uploadArea = document.getElementById('photo-upload-area');
            const fileInput = document.getElementById('file-input');
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) processImage(e.target.files[0]);
            });

            document.getElementById('btn-get-location').addEventListener('click', getRealLocation);
            document.getElementById('btn-submit').addEventListener('click', submitReport);
        }

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                uploadedImageBase64 = e.target.result;
                document.getElementById('state-idle').classList.add('hidden');
                document.getElementById('state-success').classList.add('hidden');
                document.getElementById('state-scanning').classList.remove('hidden');
                document.getElementById('preview-img').src = uploadedImageBase64;

                // Simulate AI Scanning Time
                setTimeout(() => finishScanning(), 2500);
            };
            reader.readAsDataURL(file);
        }

        function finishScanning() {
            document.getElementById('state-scanning').classList.add('hidden');
            document.getElementById('state-success').classList.remove('hidden');
            document.getElementById('final-img').src = uploadedImageBase64;

            // Show AI Badge
            const aiMsg = document.getElementById('ai-success-msg');
            aiMsg.classList.remove('hidden');
            setTimeout(() => {
                aiMsg.classList.remove('translate-y-4', 'opacity-0');
            }, 100);

            // Auto-fill description
            const descInput = document.getElementById('input-desc');
            if (!descInput.value) descInput.value = "Terdeteksi tumpukan sampah yang perlu penanganan segera.";

            isPhotoReady = true;
            checkValidation();
        }

        function getRealLocation() {
            const btn = document.getElementById('btn-get-location');
            const loading = document.getElementById('map-loading');
            loading.classList.remove('hidden');
            btn.disabled = true;

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        handleLocationSuccess(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        alert("Gagal mengambil lokasi. Pastikan GPS aktif.");
                        loading.classList.add('hidden');
                        btn.disabled = false;
                        handleLocationSuccess(-8.5833, 116.1167, true); // Fallback
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } else {
                alert("Browser tidak mendukung Geolocation.");
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function handleLocationSuccess(lat, lng, isFallback = false) {
            const loading = document.getElementById('map-loading');

            map.flyTo([lat, lng], 17);
            if (marker) map.removeLayer(marker);

            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            marker.bindPopup(isFallback ? "Geser pin ke lokasi manual." : "Lokasi Terkunci").openPopup();

            marker.on('dragend', function (event) {
                const position = marker.getLatLng();
                updateAddressUI(position.lat, position.lng, true);
            });

            updateAddressUI(lat, lng);
            loading.classList.add('hidden');
            isLocationReady = true;
            checkValidation();
        }

        function updateAddressUI(lat, lng, isDrag = false) {
            const address = `Jl. Koordinat ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            document.getElementById('detected-address').textContent = address + (isDrag ? " (Manual)" : "");
            document.getElementById('detected-coords').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;

            // Visual feedback
            const box = document.getElementById('address-box');
            box.classList.add('bg-blue-50', 'rounded-xl');
            setTimeout(() => box.classList.remove('bg-blue-50'), 500);
        }

        function checkValidation() {
            const btnSubmit = document.getElementById('btn-submit');
            if (isPhotoReady && isLocationReady && !isSubmitting) {
                btnSubmit.disabled = false;
                btnSubmit.classList.remove('bg-slate-200', 'text-slate-400');
                btnSubmit.classList.add('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30', 'hover:bg-blue-700');
                btnSubmit.innerHTML = `<span class="material-symbols-outlined text-xl">send</span><span>Kirim Laporan</span>`;
            }
        }

        function submitReport() {
            if (isSubmitting) return;
            isSubmitting = true;

            const btnSubmit = document.getElementById('btn-submit');
            btnSubmit.innerHTML = `<span class="material-symbols-outlined animate-spin text-xl">sync</span><span>Mengirim...</span>`;
            btnSubmit.disabled = true;

            const newReport = {
                id: 'CTR-' + Math.floor(Date.now() / 1000),
                userId: currentUser.id,
                reporterName: currentUser.name,
                category: "Laporan Kebersihan",
                location: document.getElementById('detected-address').textContent,
                description: document.getElementById('input-desc').value,
                status: 'Pending',
                priority: 'Medium',
                date: new Date().toLocaleDateString('id-ID'),
                photos: [uploadedImageBase64],
                timeline: [{ status: 'Submitted', date: new Date().toLocaleDateString('id-ID'), latest: true }]
            };

            setTimeout(() => {
                const reports = getSharedReports();
                reports.unshift(newReport);
                saveSharedReports(reports);
                updateUserPoints(currentUser.id, 10, `Reward Laporan`);

                const modal = document.getElementById('success-modal');
                const content = document.getElementById('modal-content');
                const rewardAnim = document.getElementById('reward-animation');

                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                    setTimeout(() => rewardAnim.classList.remove('hidden'), 400);
                }, 50);
            }, 1500);
        }
    </script>
</body>

</html>