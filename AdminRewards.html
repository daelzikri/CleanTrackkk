<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Rewards Management - CleanTrack Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2A62C8",
                        "secondary": "#50E3C2",
                        "background-light": "#f5f5f5",
                        "background-dark": "#1a1a1a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#242424",
                        "border-light": "#e0e0e0",
                        "border-dark": "#3a3a3a",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"],
                        "mono": ["Space Mono", "monospace"]
                    },
                },
            },
        }
    </script>

    <script src="admin-header.js"></script>
    <script src="admin-utils.js"></script>

    <style>
        ::-webkit-scrollbar {
            display: none;
        }

        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
            display: block;
            /* Show only horizontal scrollbar for table */
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-100">
    <div class="min-h-screen flex flex-col">

        <div id="app-header"></div>

        <main class="flex-1 container mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-2xl font-black text-gray-900 dark:text-white tracking-tight">Manajemen Hadiah</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Kelola katalog penukaran poin dan API.</p>
                </div>
                <button onclick="openModal('add')"
                    class="flex items-center gap-2 px-6 py-2.5 bg-primary text-white rounded-xl text-sm font-bold hover:bg-primary/90 transition-all shadow-lg shadow-primary/30 active:scale-95">
                    <span class="material-symbols-outlined text-lg">add</span> Tambah Hadiah
                </button>
            </div>

            <!-- RESPONSIVE STATS GRID -->
            <!-- Mobile: 1, Tablet: 2, Desktop: 3 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div
                    class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-border-light dark:border-border-dark shadow-sm flex items-center gap-4">
                    <div class="p-3 bg-purple-50 text-purple-600 rounded-lg flex-shrink-0">
                        <span class="material-symbols-outlined text-2xl">redeem</span>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Total Item Aktif</p>
                        <h3 class="text-2xl font-black text-gray-900 dark:text-white" id="stat-total-items">0</h3>
                    </div>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-border-light dark:border-border-dark shadow-sm flex items-center gap-4">
                    <div class="p-3 bg-blue-50 text-blue-600 rounded-lg flex-shrink-0">
                        <span class="material-symbols-outlined text-2xl">api</span>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">API Terhubung</p>
                        <h3 class="text-2xl font-black text-gray-900 dark:text-white" id="stat-api-connected">0</h3>
                    </div>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-border-light dark:border-border-dark shadow-sm flex items-center gap-4">
                    <div class="p-3 bg-green-50 text-green-600 rounded-lg flex-shrink-0">
                        <span class="material-symbols-outlined text-2xl">inventory_2</span>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Total Stok</p>
                        <h3 class="text-2xl font-black text-gray-900 dark:text-white" id="stat-total-stock">0</h3>
                    </div>
                </div>
            </div>

            <div
                class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm overflow-hidden">

                <div
                    class="p-4 border-b border-border-light dark:border-border-dark flex flex-col md:flex-row gap-4 justify-between items-center bg-gray-50/50 dark:bg-gray-800/50">
                    <div class="relative w-full md:w-96">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                        <input type="text" id="search-input"
                            class="w-full pl-10 pr-4 py-2 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-surface-dark focus:ring-2 focus:ring-primary focus:border-primary transition-all text-sm font-medium"
                            placeholder="Cari nama hadiah atau kode...">
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <select id="filter-category"
                            class="w-full md:w-auto py-2 pl-3 pr-8 rounded-lg border-gray-300 text-sm font-bold text-gray-600 focus:ring-primary">
                            <option value="All">Semua Kategori</option>
                            <option value="Pulsa">Pulsa</option>
                            <option value="PLN">Token PLN</option>
                            <option value="E-Wallet">E-Wallet</option>
                        </select>
                    </div>
                </div>

                <!-- RESPONSIVE TABLE CONTAINER -->
                <div class="overflow-x-auto w-full table-container">
                    <table class="w-full text-left border-collapse whitespace-nowrap">
                        <thead class="bg-gray-50 dark:bg-gray-800 border-b border-border-light dark:border-border-dark">
                            <tr>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">Item Info
                                </th>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">Kategori
                                </th>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">Harga
                                    (Poin)</th>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">API Config
                                </th>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">Stok</th>
                                <th
                                    class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider text-right">
                                    Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rewards-table-body"
                            class="divide-y divide-border-light dark:divide-border-dark text-sm">
                        </tbody>
                    </table>
                </div>

                <div id="empty-state" class="hidden p-12 text-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-3xl text-gray-400">inventory_2</span>
                    </div>
                    <p class="text-gray-500 font-bold">Belum ada item hadiah.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL & SCRIPTS -->
    <div id="reward-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div
            class="bg-white dark:bg-surface-dark rounded-2xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden transform transition-all scale-100">
            <div
                class="px-6 py-4 border-b border-border-light dark:border-border-dark flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                <h3 class="text-lg font-black text-gray-900 dark:text-white" id="modal-title">Tambah Hadiah Baru</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <form id="reward-form" class="p-6 space-y-5 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="input-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Produk</label>
                        <input type="text" id="input-name" required
                            class="w-full rounded-lg border-gray-300 dark:bg-surface-dark text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kategori</label>
                        <select id="input-category"
                            class="w-full rounded-lg border-gray-300 dark:bg-surface-dark text-sm">
                            <option value="PLN">Token PLN</option>
                            <option value="Pulsa">Pulsa Reguler</option>
                            <option value="E-Wallet">Saldo E-Wallet</option>
                            <option value="Voucher">Voucher Belanja</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Harga Poin</label>
                        <input type="number" id="input-cost" required min="1"
                            class="w-full rounded-lg border-gray-300 dark:bg-surface-dark text-sm font-mono">
                    </div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                    <h4 class="text-xs font-black text-blue-800 dark:text-blue-300 uppercase tracking-wide mb-3">API
                        Backend</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-[10px] font-bold text-blue-600/80 mb-1">PROVIDER ID</label><input
                                type="text" id="input-provider"
                                class="w-full rounded bg-white border-blue-200 text-xs font-mono px-2 py-1.5 uppercase">
                        </div>
                        <div><label class="block text-[10px] font-bold text-blue-600/80 mb-1">PRODUCT CODE</label><input
                                type="text" id="input-code"
                                class="w-full rounded bg-white border-blue-200 text-xs font-mono px-2 py-1.5 uppercase">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Stok Awal</label><input
                            type="number" id="input-stock" required min="0"
                            class="w-full rounded-lg border-gray-300 dark:bg-surface-dark text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">URL Gambar</label><input
                            type="text" id="input-image"
                            class="w-full rounded-lg border-gray-300 dark:bg-surface-dark text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Deskripsi</label><textarea
                        id="input-desc" rows="2"
                        class="w-full rounded-lg border-gray-300 dark:bg-surface-dark text-sm"></textarea></div>
            </form>
            <div
                class="px-6 py-4 border-t border-border-light dark:border-border-dark flex justify-end gap-2 bg-gray-50 dark:bg-gray-800/50">
                <button onclick="closeModal()"
                    class="px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-200">Batal</button>
                <button onclick="saveReward()"
                    class="px-6 py-2 rounded-lg text-sm font-bold bg-primary text-white hover:bg-primary/90 shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-6 right-6 transform translate-y-24 opacity-0 transition-all duration-300 z-[200]">
        <div class="bg-gray-900 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3">
            <span class="material-symbols-outlined text-green-400">check_circle</span>
            <p id="toast-message" class="text-sm font-bold">Data berhasil disimpan</p>
        </div>
    </div>

    <script>
        let allRewards = [];
        let isEditing = false;

        document.addEventListener('DOMContentLoaded', () => {
            renderAdminHeader('rewards');
            initAdminData();
            loadRewards();
            document.getElementById('search-input').addEventListener('input', handleFilter);
            document.getElementById('filter-category').addEventListener('change', handleFilter);
        });

        function loadRewards() {
            allRewards = getRewards();
            renderTable(allRewards);
            updateStats();
        }

        function updateStats() {
            document.getElementById('stat-total-items').textContent = allRewards.length;
            document.getElementById('stat-api-connected').textContent = allRewards.filter(r => r.api_code && r.api_code.trim() !== '').length;
            document.getElementById('stat-total-stock').textContent = allRewards.reduce((sum, item) => sum + parseInt(item.stock || 0), 0);
        }

        function renderTable(data) {
            const tbody = document.getElementById('rewards-table-body');
            const emptyState = document.getElementById('empty-state');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.closest('div').classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tbody.closest('div').classList.remove('hidden');

            data.forEach(item => {
                let icon = 'inventory_2';
                if (item.category === 'PLN') icon = 'bolt';
                if (item.category === 'Pulsa') icon = 'phonelink_ring';
                if (item.category === 'E-Wallet') icon = 'account_balance_wallet';
                const imgUrl = item.image || `https://ui-avatars.com/api/?name=${encodeURIComponent(item.name)}&background=random&color=fff&size=64`;

                const row = `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group">
                    <td class="p-4 align-top"><div class="flex items-start gap-3"><div class="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden shrink-0 border border-gray-200"><img src="${imgUrl}" class="w-full h-full object-cover"></div><div><p class="text-sm font-bold text-gray-900 dark:text-gray-100">${item.name}</p><p class="text-[10px] text-gray-400 font-mono mt-0.5">${item.id}</p></div></div></td>
                    <td class="p-4 align-top"><span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-bold bg-gray-100 text-gray-600 border border-gray-200"><span class="material-symbols-outlined text-[14px]">${icon}</span>${item.category}</span></td>
                    <td class="p-4 align-top"><span class="text-sm font-black text-yellow-600 bg-yellow-50 px-2 py-1 rounded border border-yellow-100">${item.cost} Pts</span></td>
                    <td class="p-4 align-top"><div class="flex flex-col gap-1"><div class="flex items-center gap-1 text-[10px] text-gray-500 font-mono"><span class="font-bold text-gray-400 w-8">PRV:</span><span class="bg-blue-50 text-blue-700 px-1 rounded">${item.api_provider || '-'}</span></div><div class="flex items-center gap-1 text-[10px] text-gray-500 font-mono"><span class="font-bold text-gray-400 w-8">CDE:</span><span class="bg-purple-50 text-purple-700 px-1 rounded">${item.api_code || '-'}</span></div></div></td>
                    <td class="p-4 align-top"><span class="text-sm font-medium ${item.stock < 10 ? 'text-red-500' : 'text-gray-700'}">${item.stock} Unit</span></td>
                    <td class="p-4 align-top text-right"><div class="flex justify-end gap-2"><button onclick="editItem('${item.id}')" class="p-1.5 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200"><span class="material-symbols-outlined text-[18px]">edit</span></button><button onclick="deleteItem('${item.id}')" class="p-1.5 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 border border-red-200"><span class="material-symbols-outlined text-[18px]">delete</span></button></div></td>
                </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function openModal(mode, id = null) {
            const modal = document.getElementById('reward-modal');
            const form = document.getElementById('reward-form');
            const title = document.getElementById('modal-title');
            form.reset();

            if (mode === 'edit') {
                isEditing = true;
                title.textContent = "Edit Data Hadiah";
                const item = allRewards.find(r => r.id === id);
                if (item) {
                    document.getElementById('input-id').value = item.id;
                    document.getElementById('input-name').value = item.name;
                    document.getElementById('input-category').value = item.category;
                    document.getElementById('input-cost').value = item.cost;
                    document.getElementById('input-stock').value = item.stock;
                    document.getElementById('input-provider').value = item.api_provider || '';
                    document.getElementById('input-code').value = item.api_code || '';
                    document.getElementById('input-image').value = item.image || '';
                    document.getElementById('input-desc').value = item.description || '';
                }
            } else {
                isEditing = false;
                title.textContent = "Tambah Hadiah Baru";
                document.getElementById('input-id').value = '';
            }
            modal.classList.remove('hidden');
        }

        function closeModal() { document.getElementById('reward-modal').classList.add('hidden'); }

        function saveReward() {
            const id = document.getElementById('input-id').value;
            const name = document.getElementById('input-name').value;
            const category = document.getElementById('input-category').value;
            const cost = parseInt(document.getElementById('input-cost').value);
            const stock = parseInt(document.getElementById('input-stock').value);
            const provider = document.getElementById('input-provider').value.toUpperCase();
            const code = document.getElementById('input-code').value.toUpperCase();
            const desc = document.getElementById('input-desc').value;
            const image = document.getElementById('input-image').value;

            if (!name || isNaN(cost)) { alert("Nama dan Harga Poin wajib diisi!"); return; }

            if (isEditing && id) {
                const index = allRewards.findIndex(r => r.id === id);
                if (index !== -1) {
                    allRewards[index] = { ...allRewards[index], name, category, cost, stock, api_provider: provider, api_code: code, description: desc, image };
                }
            } else {
                const newId = 'RWD-' + Math.floor(Date.now() / 100);
                const newItem = { id: newId, name, category, cost, stock, api_provider: provider, api_code: code, description: desc, image };
                allRewards.push(newItem);
            }
            saveRewards(allRewards);
            closeModal();
            loadRewards();
            showToast(isEditing ? "Data berhasil diperbarui" : "Item baru ditambahkan");
        }

        function editItem(id) { openModal('edit', id); }

        function deleteItem(id) {
            if (confirm("Yakin ingin menghapus item ini?")) {
                allRewards = allRewards.filter(r => r.id !== id);
                saveRewards(allRewards);
                loadRewards();
                showToast("Item berhasil dihapus");
            }
        }

        function handleFilter() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const cat = document.getElementById('filter-category').value;
            const filtered = allRewards.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(search) || (item.api_code && item.api_code.toLowerCase().includes(search));
                const matchCat = cat === 'All' || item.category === cat;
                return matchSearch && matchCat;
            });
            renderTable(filtered);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-y-24', 'opacity-0'); }, 3000);
        }
    </script>
</body>

</html>