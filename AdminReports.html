<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Reports Management - CleanTrack Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2A62C8",
                        "secondary": "#50E3C2",
                        "background-light": "#f5f5f5",
                        "background-dark": "#1a1a1a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#242424",
                        "border-light": "#e0e0e0",
                        "border-dark": "#3a3a3a",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"]
                    },
                },
            },
        }
    </script>

    <script src="admin-header.js"></script>
    <script src="admin-utils.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <style>
        ::-webkit-scrollbar {
            display: none;
        }

        html,
        body {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-100">
    <div class="min-h-screen flex flex-col">

        <div id="app-header"></div>

        <main class="flex-1 container mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4"
                data-aos="fade-down">
                <div>
                    <h1 class="text-2xl font-black text-gray-900 dark:text-white tracking-tight">Manajemen Laporan</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Pantau dan tindak lanjuti laporan warga.</p>
                </div>
                <div class="flex flex-wrap gap-2 w-full md:w-auto">
                    <button onclick="window.location.reload();"
                        class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors shadow-sm text-primary">
                        <span class="material-symbols-outlined text-lg">sync</span> Sinkron
                    </button>
                    <button onclick="handleExport()"
                        class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary/90 transition-colors shadow-lg shadow-primary/30">
                        <span class="material-symbols-outlined text-lg">download</span> Export
                    </button>
                </div>
            </div>

            <!-- RESPONSIVE FILTER PANEL -->
            <div class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-border-light dark:border-border-dark shadow-sm mb-6"
                data-aos="fade-up">
                <div class="flex flex-col lg:flex-row gap-4 justify-between">

                    <div class="relative flex-1">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                        <input type="text" id="search-input"
                            class="w-full pl-10 pr-4 py-2.5 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-surface-dark focus:ring-2 focus:ring-primary focus:border-primary transition-all text-sm font-medium"
                            placeholder="Cari ID Laporan, Nama Pelapor, atau Lokasi...">
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="relative w-full sm:w-auto sm:min-w-[150px]">
                            <select id="filter-time"
                                class="w-full pl-3 pr-8 py-2.5 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-surface-dark text-sm font-bold text-gray-600 focus:ring-primary focus:border-primary cursor-pointer">
                                <option value="all">Semua Waktu</option>
                                <option value="today">Hari Ini</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                            </select>
                        </div>

                        <div class="relative w-full sm:w-auto sm:min-w-[180px]">
                            <select id="filter-status"
                                class="w-full pl-3 pr-10 py-2.5 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-surface-dark text-sm font-bold text-gray-600 focus:ring-primary focus:border-primary cursor-pointer">
                                <option value="All">Semua Status</option>
                                <option value="Pending">Pending (Menunggu)</option>
                                <option value="In Progress">In Progress (Proses)</option>
                                <option value="Resolved">Resolved (Selesai)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm overflow-hidden"
                data-aos="fade-up" data-aos-delay="100">

                <!-- RESPONSIVE TABLE WRAPPER -->
                <div class="overflow-x-auto w-full">
                    <table class="w-full text-left border-collapse whitespace-nowrap">
                        <thead class="bg-gray-50 dark:bg-gray-800 border-b border-border-light dark:border-border-dark">
                            <tr>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">ID & Tgl
                                </th>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">Pelapor
                                </th>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">Lokasi
                                </th>
                                <th class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider">Status
                                </th>
                                <th
                                    class="p-4 text-xs font-extrabold text-gray-500 uppercase tracking-wider text-right">
                                    Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body"
                            class="divide-y divide-border-light dark:divide-border-dark text-sm">
                        </tbody>
                    </table>
                </div>

                <div
                    class="p-4 border-t border-border-light dark:border-border-dark bg-gray-50 dark:bg-gray-800 flex justify-between items-center">
                    <p class="text-xs font-bold text-gray-500" id="showing-text">Menampilkan 0 data</p>
                    <div class="flex gap-2">
                        <button id="btn-prev" onclick="changePage(-1)" disabled
                            class="px-3 py-1.5 rounded-lg border border-gray-300 bg-white text-xs font-bold text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            Prev
                        </button>
                        <button id="btn-next" onclick="changePage(1)" disabled
                            class="px-3 py-1.5 rounded-lg border border-gray-300 bg-white text-xs font-bold text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            Next
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 transform translate-y-24 opacity-0 transition-all duration-300 z-50">
        <div class="bg-gray-900 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3">
            <span class="material-symbols-outlined text-green-400">check_circle</span>
            <p id="toast-message" class="text-sm font-bold">Berhasil update status</p>
        </div>
    </div>

    <script>
        AOS.init();
        let allReports = [];
        let displayedReports = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        document.addEventListener('DOMContentLoaded', () => {
            renderAdminHeader('reports');
            initAdminData();
            allReports = getReports();
            handleFilter();

            document.getElementById('search-input').addEventListener('input', handleFilter);
            document.getElementById('filter-status').addEventListener('change', handleFilter);
            document.getElementById('filter-time').addEventListener('change', handleFilter);

            window.addEventListener('storageUpdated', () => {
                allReports = getReports();
                handleFilter();
            });
        });

        function handleFilter() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const timeFilter = document.getElementById('filter-time').value;

            let filtered = filterByDate(allReports, timeFilter);

            filtered = filtered.filter(report => {
                const matchesSearch =
                    report.id.toLowerCase().includes(searchText) ||
                    (report.reporterName && report.reporterName.toLowerCase().includes(searchText)) ||
                    report.location.toLowerCase().includes(searchText);
                const matchesStatus = statusFilter === 'All' || report.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            displayedReports = filtered;
            currentPage = 1;
            renderTable(filtered);
        }

        function handleExport() { exportToCSV(displayedReports); }

        function changePage(direction) {
            const totalPages = Math.ceil(displayedReports.length / itemsPerPage);
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable(displayedReports);
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('reports-table-body');
            const countLabel = document.getElementById('showing-text');
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');

            tbody.innerHTML = '';

            if (data.length === 0) {
                countLabel.textContent = `Menampilkan 0 data`;
                btnPrev.disabled = true;
                btnNext.disabled = true;
                tbody.innerHTML = `<tr><td colspan="6" class="p-12 text-center text-gray-400"><div class="flex flex-col items-center gap-2"><span class="material-symbols-outlined text-4xl text-gray-300">search_off</span><p class="text-sm">Tidak ada data.</p></div></td></tr>`;
                return;
            }

            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedData = data.slice(startIndex, endIndex);

            countLabel.textContent = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalItems} data`;
            btnPrev.disabled = currentPage === 1;
            btnNext.disabled = currentPage === totalPages;

            paginatedData.forEach(report => {
                const statusStyle = getStatusColor(report.status);
                const priorityStyle = getPriorityColor(report.priority || 'Medium');
                const reporterInitial = report.reporterName ? report.reporterName.charAt(0).toUpperCase() : '?';

                let ratingIndicator = '';
                if (report.status === 'Resolved' && report.rating) {
                    ratingIndicator = `<div class="ml-2 flex items-center gap-0.5 bg-yellow-50 px-1.5 py-0.5 rounded border border-yellow-100"><span class="material-symbols-outlined text-[14px] text-yellow-500 fill-current">star</span><span class="text-[10px] font-bold text-yellow-700">${report.rating}</span></div>`;
                }

                let actionButtons = '';
                if (report.status === 'Pending') {
                    actionButtons = `<button onclick="changeStatus('${report.id}', 'In Progress')" class="p-1.5 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200" title="Proses"><span class="material-symbols-outlined text-[18px]">play_arrow</span></button> <button onclick="deleteReport('${report.id}')" class="p-1.5 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 border border-red-200" title="Hapus"><span class="material-symbols-outlined text-[18px]">delete</span></button>`;
                } else if (report.status === 'In Progress') {
                    actionButtons = `<button onclick="changeStatus('${report.id}', 'Resolved')" class="p-1.5 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 border border-green-200" title="Selesai"><span class="material-symbols-outlined text-[18px]">check</span></button>`;
                } else {
                    actionButtons = `<span class="material-symbols-outlined text-gray-300 text-[18px]">lock</span>`;
                }

                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group">
                        <td class="p-4 align-top"><div class="flex flex-col"><span class="font-mono text-xs font-bold text-gray-600 bg-gray-100 px-2 py-0.5 rounded w-fit">${report.id}</span><span class="text-[10px] text-gray-400 mt-1">${report.date}</span></div></td>
                        <td class="p-4 align-top"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-primary/10 border border-primary/20 flex items-center justify-center text-xs font-bold text-primary shadow-sm">${reporterInitial}</div><div><p class="font-bold text-sm text-gray-900 dark:text-gray-100 line-clamp-1">${report.reporterName}</p><p class="text-[10px] text-gray-400">UID: ${report.userId || '-'}</p></div></div></td>
                        <td class="p-4 align-top"><div class="flex items-start gap-1 max-w-[200px]"><span class="material-symbols-outlined text-[16px] text-gray-400 mt-0.5 shrink-0">location_on</span><span class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2">${report.location}</span></div><span class="inline-flex mt-1 items-center px-1.5 py-0.5 rounded text-[10px] font-bold border ${priorityStyle}">${report.priority || 'Medium'}</span></td>
                        <td class="p-4 align-top"><div class="flex items-center"><span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold border ${statusStyle.badge}"><span class="w-1.5 h-1.5 rounded-full ${statusStyle.dot}"></span>${report.status}</span>${ratingIndicator}</div></td>
                        <td class="p-4 align-middle text-right"><div class="flex items-center justify-end gap-2">${actionButtons}<a href="AdminReportDetail.html?id=${report.id}" class="p-1.5 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-200"><span class="material-symbols-outlined text-[18px]">visibility</span></a></div></td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function changeStatus(id, newStatus) {
            const index = allReports.findIndex(r => r.id === id);
            if (index !== -1) {
                allReports[index].status = newStatus;
                if (!allReports[index].timeline) allReports[index].timeline = [];
                allReports[index].timeline.unshift({ status: newStatus, date: new Date().toLocaleDateString('id-ID'), latest: true, icon: newStatus === 'Resolved' ? 'check_circle' : 'sync' });
                saveReports(allReports);
                handleFilter();
                showToast(`Status: ${newStatus}`);
            }
        }

        function deleteReport(id) {
            if (confirm("Hapus laporan ini?")) {
                allReports = allReports.filter(r => r.id !== id);
                saveReports(allReports);
                handleFilter();
                showToast("Laporan dihapus.");
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
        }
    </script>
</body>

</html>